<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- PWA Meta Tags -->
    <title>DSE - PWA Test</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4A90E2">

    <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Divine Scripture Explorer</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4A90E2">

    <!-- Favicon (Optional but Recommended) -->
    <!-- <link rel="icon" href="/favicon.ico" sizes="any"> -->
    <!-- <link rel="icon" href="/icon.svg" type="image/svg+xml"> -->
    <!-- <link rel="apple-touch-icon" href="/apple-touch-icon.png"> -->

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Combined Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,700;1,400&family=Inter:wght@300;400;500;600&family=Montserrat:wght@400;600&family=Roboto:wght@300;400&family=Noto+Serif:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet"> <!-- Added Noto Serif if you use it from the demo -->
    <!-- Font Awesome (for icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>


    <!-- CSS (Assuming your CSS file exists and is linked here) -->
    <link rel="stylesheet" href="style.css"> <!-- MAKE SURE YOUR CSS FILE IS CORRECTLY NAMED/LINKED -->

<link rel="stylesheet" href="styles/theme.css">
</head>
<body>
    <div class="app-container">
        <!-- REMOVED: Header Section (as per your previous change) -->

        <!-- Desktop/Tablet View Tabs -->
        <div class="view-tabs-container">
             <div class="view-tabs" id="mainViewTabs" role="tablist" aria-label="Main views">
                 <button id="tab-themeView" role="tab" aria-controls="themeView" aria-selected="true" data-view="themeView">Themes</button>
                 <button id="tab-bookListView" role="tab" aria-controls="bookListView" aria-selected="false" data-view="bookListView">Books</button>
                 <!-- READING TAB BUTTON REMOVED as it's now an overlay -->
                 <button id="tab-notesView" role="tab" aria-controls="notesView" aria-selected="false" data-view="notesView"><span class="icon" aria-hidden="true">ðŸ“</span> Notes</button>
                 <button id="tab-settingsView" role="tab" aria-controls="settingsView" aria-selected="false" data-view="settingsView">Settings</button>
             </div>
        </div>

        <main id="main-app-content" class="main-app-content" role="main">

            <!-- Reading Tab View Panel removed -->

            <!-- Theme View -->
            <div id="themeView" class="tab-panel active" role="tabpanel" aria-labelledby="tab-themeView">
                <h2 class="visually-hidden">Themes</h2>

                <!-- START: Integrated Verse Card Placeholder -->
                <div class="verse-card" id="verseCard">
                    <!-- Add menu-wrapper around dots -->
                    <div class="menu-wrapper">
                        <div class="menu-dots" id="menuDots" role="button" aria-haspopup="true" aria-expanded="false" aria-label="Verse options">â‹„1¤7</div>
                        <!-- DROPDOWN MENU MOVED OUTSIDE THIS DIV -->
                    </div>

                    <!-- These elements will be populated by JS -->
                    <div class="verse-title" id="verseCardTitle">Today's Scripture</div>
                    <div class="verse-text" id="verseCardText"></div>
                    <div class="verse-reference" id="verseCardReference"></div>
                </div>
                <!-- END: Integrated Verse Card Placeholder -->

                <div class="theme-cards-container">
                    <!-- Recent Theme Card -->
                    <div class="theme-card recent-theme-card" tabindex="0" data-theme-name="Recent">
                        <div class="theme-card-header">
                            <h2>Recent Books</h2>
                            <div class="subtitle">Jump back in</div>
                            <div class="scripture-icon" aria-hidden="true">ðŸ•°ï¸„1¤7</div> <!-- Using an hourglass/time icon -->
                        </div>
                        <div class="theme-card-content" role="region" aria-label="Recently read books">
                            <div class="books-container" id="recentBooksContainer">
                                <p class="loading-books"><span class="loading-dots">Loading recent books...</span></p> <!-- Placeholder for JS content -->
                                <!-- JS will populate .book-card elements here -->
                                <p class="empty-list-message recent-empty-message" style="display: none;">No recent books yet.</p>
                            </div>
                        </div>
                    </div>
                    <!-- Existing Theme Cards follow... -->
                    <!-- Creation & Origins -->
                    <div class="theme-card" tabindex="0" data-theme-name="Creation & Origins"><div class="theme-card-header"><h2>Creation & Origins</h2><div class="subtitle">God Starts the Story</div><div class="scripture-icon" aria-hidden="true">ðŸŒŒ</div></div><div class="theme-card-content" role="region" aria-label="Books related to Creation & Origins"><p class="intro-text">Where it all began...</p><div class="books-container"><p class="loading-books">Loading books...</p></div></div></div>
                    <!-- Law & Covenant -->
                     <div class="theme-card" tabindex="0" data-theme-name="Law & Covenant"><div class="theme-card-header"><h2>Law & Covenant</h2><div class="subtitle">God Defines the Relationship</div><div class="scripture-icon" aria-hidden="true">âš–ï¸</div></div><div class="theme-card-content" role="region" aria-label="Books related to Law & Covenant"><p class="intro-text">The blueprint for holiness...</p><div class="books-container"><p class="loading-books">Loading books...</p></div></div></div>
                    <!-- Kingship & Nationhood -->
                    <div class="theme-card" tabindex="0" data-theme-name="Kingship & Nationhood"><div class="theme-card-header"><h2>Kingship & Nationhood</h2><div class="subtitle">God Builds a People</div><div class="scripture-icon" aria-hidden="true">ðŸ‘‘</div></div><div class="theme-card-content" role="region" aria-label="Books related to Kingship & Nationhood"><p class="intro-text">The rise and fall of Israel...</p><div class="books-container"><p class="loading-books">Loading books...</p></div></div></div>
                    <!-- Wisdom & Daily Life -->
                    <div class="theme-card" tabindex="0" data-theme-name="Wisdom & Daily Life"><div class="theme-card-header"><h2>Wisdom & Daily Life</h2><div class="subtitle">God Speaks to the Human Condition</div><div class="scripture-icon" aria-hidden="true">ðŸ§ </div></div><div class="theme-card-content" role="region" aria-label="Books related to Wisdom & Daily Life"><p class="intro-text">Poetry, questions, hard truths...</p><div class="books-container"><p class="loading-books">Loading books...</p></div></div></div>
                    <!-- Prophetic Warnings -->
                    <div class="theme-card" tabindex="0" data-theme-name="Prophetic Warnings"><div class="theme-card-header"><h2>Prophetic Warnings</h2><div class="subtitle">God Calls for Repentance</div><div class="scripture-icon" aria-hidden="true">ðŸ”¥</div></div><div class="theme-card-content" role="region" aria-label="Books related to Prophetic Warnings"><p class="intro-text">Voices in the wilderness...</p><div class="books-container"><p class="loading-books">Loading books...</p></div></div></div>
                    <!-- Messianic Fulfillment -->
                    <div class="theme-card" tabindex="0" data-theme-name="Messianic Fulfillment"><div class="theme-card-header"><h2>Messianic Fulfillment</h2><div class="subtitle">God Steps In Himself</div><div class="scripture-icon" aria-hidden="true">âœï¸</div></div><div class="theme-card-content" role="region" aria-label="Books related to Messianic Fulfillment"><p class="intro-text">Jesus Christ shows up...</p><div class="books-container"><p class="loading-books">Loading books...</p></div></div></div>
                    <!-- Church Formation -->
                    <div class="theme-card" tabindex="0" data-theme-name="Church Formation"><div class="theme-card-header"><h2>Church Formation</h2><div class="subtitle">God Raises a Movement</div><div class="scripture-icon" aria-hidden="true">â›„1¤7</div></div><div class="theme-card-content" role="region" aria-label="Books related to Church Formation"><p class="intro-text">The apostles act...</p><div class="books-container"><p class="loading-books">Loading books...</p></div></div></div>
                    <!-- Apocalyptic Vision -->
                    <div class="theme-card" tabindex="0" data-theme-name="Apocalyptic Vision"><div class="theme-card-header"><h2>Apocalyptic Vision</h2><div class="subtitle">God Lifts the Veil</div><div class="scripture-icon" aria-hidden="true">ðŸ‘ï¸â„1¤7ðŸ—¨ï¸</div></div><div class="theme-card-content" role="region" aria-label="Books related to Apocalyptic Vision"><p class="intro-text">Heaven's visions, end-time prophecies...</p><div class="books-container"><p class="loading-books">Loading books...</p></div></div></div>
                    <!-- Faithful Witness & Resistance -->
                     <div class="theme-card" tabindex="0" data-theme-name="Faithful Witness & Resistance"><div class="theme-card-header"><h2>Faithful Witness & Resistance</h2><div class="subtitle">God's People Under Fire</div><div class="scripture-icon" aria-hidden="true">ðŸ›¡ï¸„1¤7</div></div><div class="theme-card-content" role="region" aria-label="Books related to Faithful Witness & Resistance"><p class="intro-text">Stories of courage, faith...</p><div class="books-container"><p class="loading-books">Loading books...</p></div></div></div>
                </div> <!-- /.theme-cards-container -->
            </div> <!-- /#themeView -->


            <!-- Book List View -->
            <div id="bookListView" class="tab-panel hidden" role="tabpanel" aria-labelledby="tab-bookListView">
                <h2 class="visually-hidden">Book List and Search</h2>
                <!-- Book List Search Container -->
                <div id="bookListSearchContainer" class="book-list-search">
                    <label for="bookListSearchInput" class="visually-hidden">Search Reference or Keyword</label>
                    <input type="search" id="bookListSearchInput" placeholder="e.g., Genesis 1:1, John 3, love" aria-label="Search Reference or Keyword">
                    <button id="bookListSearchButton" class="button-primary" aria-label="Search books or keywords">Search</button>
                    <!-- REMOVED: button id="bookListClearSearchButton" -->
                </div>
                 <!-- Search Results Display -->
                <div id="bookListNoResults" class="no-results-message" style="display: none;" aria-live="polite"></div>
                <div id="bookListSearchResultsContainer" style="display: none;" aria-live="polite"></div>

                <!-- Standard Book List Content -->
                <div id="bookListStandardContent">
                     <div class="content-tabs" id="bookListTabsContainer" role="tablist" aria-label="Filter books by testament">
                         <button id="tab-bookListTabOT" role="tab" aria-controls="bookListTabOT" aria-selected="true" data-tab="bookListTabOT">Old Testament</button>
                         <button id="tab-bookListTabAP" role="tab" aria-controls="bookListTabAP" aria-selected="false" data-tab="bookListTabAP">Apocrypha / EOTC</button>
                         <button id="tab-bookListTabNT" role="tab" aria-controls="bookListTabNT" aria-selected="false" data-tab="bookListTabNT">New Testament</button>
                          <button id="tab-bookListTabOTHER" role="tab" aria-controls="bookListTabOTHER" aria-selected="false" data-tab="bookListTabOTHER" style="display: none;">Other</button>
                     </div>
                     <div class="tab-content">
                         <div id="bookListTabOT" class="tab-panel active" role="tabpanel" aria-labelledby="tab-bookListTabOT"><h2 class="testament-header">Old Testament</h2><ul class="book-list" id="bookListOT" aria-label="Old Testament Books"><!-- JS populates --></ul></div>
                         <div id="bookListTabAP" class="tab-panel hidden" role="tabpanel" aria-labelledby="tab-bookListTabAP"><h2 class="testament-header">Apocrypha / EOTC</h2><ul class="book-list" id="bookListAP" aria-label="Apocryphal and EOTC Books"><!-- JS populates --></ul></div>
                         <div id="bookListTabNT" class="tab-panel hidden" role="tabpanel" aria-labelledby="tab-bookListTabNT"><h2 class="testament-header">New Testament</h2><ul class="book-list" id="bookListNT" aria-label="New Testament Books"><!-- JS populates --></ul></div>
                         <div id="bookListTabOTHER" class="tab-panel hidden" role="tabpanel" aria-labelledby="tab-bookListTabOTHER"><h2 class="testament-header">Other Books</h2><ul class="book-list" id="bookListOTHER" aria-label="Other Books"><!-- JS populates if needed --></ul></div>
                     </div>
                </div>
            </div> <!-- /#bookListView -->

            <!-- Notes View -->
            <div id="notesView" class="tab-panel hidden" role="tabpanel" aria-labelledby="tab-notesView">
                <h2 class="visually-hidden">Notes and Favourites</h2>

                <!-- Notes View Sub-Tabs -->
                <div class="content-tabs" id="notesViewTabs" role="tablist" aria-label="Notes sections">
                    <button id="tab-userNotesPanel" role="tab" aria-controls="userNotesPanel" aria-selected="true">My Notes</button>
                    <button id="tab-userFavouritesPanel" role="tab" aria-controls="userFavouritesPanel" aria-selected="false">Favourites</button>
                    <button id="tab-userReflectionPanel" role="tab" aria-controls="userReflectionPanel" aria-selected="false">Reflection</button>
                </div>

                <!-- Notes View Sub-Tab Panels -->

                <!-- User Notes Panel -->
                <div id="userNotesPanel" class="notes-view-panel active" role="tabpanel" aria-labelledby="tab-userNotesPanel">
                    <h3 class="visually-hidden">My Notes List</h3>
                    <ul id="notesListContainer" class="user-item-list">
                        <!-- JS populates list or empty message -->
                        <li class="empty-list-message" style="display: none;">You have no saved notes yet.</li>
                    </ul>
                </div>

                <!-- User Favourites Panel -->
                <div id="userFavouritesPanel" class="notes-view-panel hidden" role="tabpanel" aria-labelledby="tab-userFavouritesPanel">
                    <h3 class="visually-hidden">Favourites List</h3>
                    <ul id="favouritesListContainer" class="user-item-list">
                         <!-- JS populates list or empty message -->
                         <li class="empty-list-message" style="display: none;">You have no saved favourites yet.</li>
                    </ul>
                </div>

                <!-- User Reflection Panel -->
                 <div id="userReflectionPanel" class="notes-view-panel hidden" role="tabpanel" aria-labelledby="tab-userReflectionPanel">
                    <h3 class="visually-hidden">My Reflection</h3>
                    <!-- NEW REFLECTION CONTENT STARTS HERE -->
                    <div class="reflection-toolbar">
                        <button id="addNewReflectionButton" class="button-primary">
                            <span class="icon" aria-hidden="true">âž„1¤7</span> Add New Reflection
                        </button>
                    </div>

                    <!-- Form for adding a NEW reflection -->
                    <div id="addReflectionForm" class="reflection-add-form">
                        <h3 class="visually-hidden">Add New Reflection Form</h3> <!-- Changed to h3 for consistency -->
                        <textarea id="newReflectionTextarea" placeholder="Write your reflection here..."></textarea>
                        <!-- Floating buttons container -->
                        <div class="form-buttons">
                            <button id="saveNewReflectionButton" class="save-button button-primary">Save Reflection</button>
                            <button id="cancelNewReflectionButton" class="cancel-button button-secondary">Cancel</button>
                        </div>
                    </div>

                    <!-- List container for SAVED reflections -->
                    <ul id="reflectionListContainer" class="user-item-list reflection-card-list">
                         <li class="empty-list-message">No reflections saved yet.</li>
                    </ul>
                    <!-- NEW REFLECTION CONTENT ENDS HERE -->
                 </div>

            </div> <!-- /#notesView -->

            <!-- Settings View -->
            <div id="settingsView" class="tab-panel hidden" role="tabpanel" aria-labelledby="tab-settingsView">
                  <h2>Settings</h2>

                  <!-- Appearance Section (Original, keep this one) -->
                  <div class="settings-section">
                    <h3 class="settings-heading">Appearance</h3>
                    <div class="setting-item">
                         <div>
                              <label for="darkModeSelect" class="setting-label">Theme</label>
                              <span class="setting-description">Light, dark, or system default.</span>
                         </div>
                         <div class="setting-control">
                              <select id="darkModeSelect">
                                   <option value="light">Light</option>
                                   <option value="dark">Dark</option>
                                   <option value="system">System</option>
                              </select>
                         </div>
                    </div>
                    <div class="setting-item">
                         <div>
                              <label for="fontSizeSlider" class="setting-label">Reading Font Size</label>
                              <span class="setting-description">Adjust the size of text in the reading view.</span>
                         </div>
                         <div class="setting-control range-control">
                              <input type="range" id="fontSizeSlider" min="0.8" max="2.0" step="0.1" value="1.1">
                              <span id="fontSizeValue" aria-live="polite">1.1em</span>
                         </div>
                    </div>
                    <div class="setting-item">
                         <div>
                              <label for="fontFamilySelect" class="setting-label">Reading Font Family</label>
                              <span class="setting-description">Choose a font style for the reading view.</span>
                         </div>
                         <div class="setting-control">
                              <select id="fontFamilySelect">
                                   <option value="'EB Garamond', serif">EB Garamond (Classic)</option>
                                   <option value="'Inter', sans-serif">Inter (Modern)</option>
                                   <option value="'Times New Roman', serif">Times New Roman</option>
                                   <option value="Georgia, serif">Georgia</option>
                                   <option value="'Noto Serif', serif">Noto Serif</option> <!-- Added Noto Serif -->
                              </select>
                         </div>
                    </div>
                    <!-- NEW: Browse View Mode Setting -->
                    <div class="setting-item">
                         <div>
                              <label for="browseViewModeSelect" class="setting-label">Primary Book Browser</label>
                              <span class="setting-description">Choose your default view for finding books.</span>
                         </div>
                         <div class="setting-control">
                              <select id="browseViewModeSelect">
                                   <option value="theme">Theme View</option>
                                   <option value="list">List View</option>
                              </select>
                         </div>
                    </div>
                    <!-- END: Browse View Mode Setting -->
                    <!-- THIS IS THE UI/DISPLAY LANGUAGE SELECTOR - KEEP THIS ONE -->
                    <div class="setting-item">
                         <div>
                              <label for="languageSelect" class="setting-label">App Display Language</label> <!-- Changed label for clarity -->
                              <span class="setting-description">Select the language for the application interface and book names.</span> <!-- Changed description -->
                         </div>
                         <div class="setting-control">
                              <select id="languageSelect">
                                   <option value="am">Amharic (áŠ áˆ›áˆ­áŠ›)</option>
                                   <option value="en">English</option>
                              </select>
                         </div>
                    </div>
                    <div class="setting-item">
                        <div>
                            <label for="autoHideDelaySelect" class="setting-label">UI Auto-Hide Delay</label>
                            <span class="setting-description">Time (in ms) before reading UI auto-hides on scroll/inactivity.</span>
                        </div>
                        <div class="setting-control">
                             <select id="autoHideDelaySelect">
                                <option value="1000">1000 ms</option>
                                <option value="2000">2000 ms</option>
                                <option value="3000">3000 ms (Default)</option>
                                <option value="5000">5000 ms</option>
                                <option value="10000">10000 ms</option>
                                <option value="99999999">Never</option>
                             </select>
                        </div>
                    </div>
                     <div class="setting-item">
                        <div>
                             <span class="setting-label">Keep Screen Awake</span>
                             <span class="setting-description">Prevents screen from dimming or locking while reading. Requires browser support.</span>
                        </div>
                        <div class="setting-control">
                            <label class="toggle-switch">
                                <input type="checkbox" id="keepAwakeToggle">
                                <span class="toggle-slider round"></span>
                            </label>
                        </div>
                    </div>
                  </div>

                <!-- NEW: Offline Reading Section (Moved from duplicate Appearance section) -->
                <div class="settings-section">
                    <h3 class="settings-heading">Offline Reading</h3> <!-- Changed to h3 -->
                    <p class="section-description">Download Bible chapters for a selected language to read offline. This stores text and commentary locally on your device.</p> <!-- Added descriptive paragraph -->

                    <!-- ADDED: Download Language Selector -->
                    <div class="setting-item">
                         <div>
                              <label for="downloadLanguageSelect" class="setting-label">Download Language</label>
                              <span class="setting-description">Choose the language version to download.</span>
                         </div>
                         <div class="setting-control">
                              <select id="downloadLanguageSelect"> <!-- THIS IS THE NEW ONE FOR DOWNLOAD -->
                                   <option value="am">Amharic (áŠ áˆ›áˆ­áŠ›)</option>
                                   <option value="en">English</option>
                              </select>
                         </div>
                    </div>
                    <!-- END ADDED: Download Language Selector -->

                    <div class="setting-item">
                        <button id="startDownloadButton" class="button-primary">Download Bible for Offline Use</button>
                        <button id="cancelDownloadButton" class="button-secondary hidden">Cancel Download</button>
                    </div>
                    <div id="downloadStatus" class="setting-item" style="display: none;"> <!-- Initially hidden, shown by JS -->
                        <p id="downloadStatusMessage"></p>
                        <progress id="downloadProgressBar" value="0" max="100" style="width: 100%; display: none;"></progress> <!-- Initially hidden, shown by JS -->
                    </div>
                    <div class="setting-item">
                         <button id="clearDownloadedDataButton" class="button-danger">Clear Downloaded Bible Data</button> <!-- More specific label -->
                    </div>
                     <!-- Clear Chapter Cache Button (Moved into Offline Reading section) -->
                     <div class="setting-item">
                          <div>
                               <span class="setting-label">Clear Chapter Cache</span>
                               <span class="setting-description">Removes all temporary and downloaded chapter text stored on this device.</span>
                          </div>
                          <div class="setting-control">
                               <button id="clearChapterCacheButton" class="button-secondary">Clear Cache</button> <!-- More concise label -->
                          </div>
                     </div>
                </div>
                <!-- END: Offline Reading Section -->


                 <!-- Data Management Section -->
                 <div class="settings-section">
                     <h3 class="settings-heading">Data Management</h3>

                     <!-- This item acts as the trigger/header for the expandable options -->
                     <div class="setting-item setting-item-trigger" id="dataManagementTrigger" role="button" tabindex="0" aria-expanded="false">
                         <div>
                             <span class="setting-label">Manage Your Personal Data</span> <!-- More specific label -->
                             <span class="setting-description">Export, Import, or Clear your Notes, Favourites, Reflections, History, and general Settings.</span> <!-- More specific description -->
                         </div>
                         <!-- Optional: Add an indicator icon -->
                         <div class="setting-control">
                             <span class="trigger-icon" aria-hidden="true">â–„1¤7</span>
                         </div>
                     </div>

                     <!-- Container that holds the actual data management buttons -->
                     <!-- Initially hidden by adding the 'hidden' class -->
                     <div id="dataManagementOptions" class="settings-options-container hidden" aria-hidden="true">

                         <!-- Export Data -->
                         <div class="setting-item">
                             <div>
                                 <span class="setting-label">Export User Data</span>
                                 <span class="setting-description">Download a backup of your notes, favourites, reflections, search history, recent books, and settings.</span>
                             </div>
                             <div class="setting-control">
                                 <button id="exportUserDataButton" class="button-secondary">Export</button>
                             </div>
                         </div>

                         <!-- Import Data -->
                         <div class="setting-item">
                             <div>
                                 <span class="setting-label">Import User Data</span>
                                 <span class="setting-description">Load notes, favourites, reflections, history, and settings from a previously exported JSON file. This will merge with existing data based on item IDs, overwriting settings and history.</span>
                             </div>
                             <div class="setting-control">
                                 <input type="file" id="importUserDataFile" accept=".json" class="visually-hidden">
                                 <label for="importUserDataFile" id="importUserDataButton" class="button-secondary">Import File</label>
                             </div>
                         </div>

                         <!-- Clear All User Data -->
                         <div class="setting-item">
                             <div>
                                 <span class="setting-label">Clear All Personal Data</span> <!-- More specific label -->
                                 <span class="setting-description">Permanently delete ALL your saved notes, favourites, reflections, search history, and recent books list, and reset all settings to defaults. This action cannot be undone.</span>
                             </div>
                             <div class="setting-control">
                                 <!-- Added button-danger class -->
                                 <button id="clearAllUserDataButton" class="button-secondary button-danger">Clear All Data</button>
                             </div>
                         </div>
                     </div>
                 </div>
                 <!-- END: Data Management Section -->


                 <!-- About & Info Section (Now Last) -->
                 <div class="settings-section">
                    <h3 class="settings-heading">About & Info</h3>
                    <div class="setting-item">
                         <!-- Updated Version -->
                         <div><span class="setting-label">About This App</span><span class="setting-description" id="appVersion">Version 2.0.0 (commentary)</span></div> <!-- Updated initial text to match JS -->
                         <div class="setting-control"><button class="link-button" id="aboutAppButton" aria-describedby="appVersion">View Details</button></div>
                    </div>
                    <div class="setting-item"><div><span class="setting-label">Canon Information</span><span class="setting-description">Details about the books included in this application.</span></div><div class="setting-control"><button class="link-button" id="canonInfoButton">View Info</button></div></div>
                 </div>

            </div> <!-- /#settingsView -->

        </main> <!-- /#main-app-content -->

        <!-- Verse Card Dropdown Menu (Moved outside verse-card) -->
         <div class="dropdown-menu" id="dropdownMenu" role="menu" aria-hidden="true">
             <button class="menu-item" id="createImageBtn" role="menuitem">
                 <i class="fas fa-image"></i> <span>Create Image (WIP)</span>
             </button>
             <button class="menu-item" id="shareBtn" role="menuitem">
                 <i class="fas fa-share-alt"></i> <span>Share Verse</span>
             </button>
             <button class="menu-item" id="saveBtn" role="menuitem">
                 <i class="fas fa-bookmark"></i> <span>Save as Favourite</span>
             </button>
              <!-- ADDED: Copy button to VOD dropdown -->
              <button class="menu-item" id="copyBtn" role="menuitem">
                  <i class="fas fa-copy"></i> <span>Copy Text</span>
             </button>
         </div>
        <!-- END Verse Card Dropdown Menu -->


        <!-- Reading View (Modal/Overlay) -->
        <div class="reading-view" id="readingView" aria-modal="true" aria-hidden="true" role="dialog" aria-labelledby="readingViewLabel">
             <div class="reading-container">
                 <div class="reading-header">
                    <h2 id="readingViewLabel"><!-- JS populates --></h2>
                    <div id="crossRefBackButtonContainer" style="position: absolute; top: 5px; left: 45px; z-index: 1;"><!-- JS populates --></div>
                    <div class="reading-controls">
                        <button id="closeReadingViewButton" aria-label="Close reading view"><span class="icon" aria-hidden="true">â†„1¤7</span> <span class="visually-hidden">Back</span></button>
                         <!-- ADDED: Language Quick Toggle Button -->
                        <button id="readingQuickLanguageButton" aria-label="Switch language">AM/EN</button> <!-- Initial text can be placeholder -->
                         <!-- ADDED: Commentary Quick Toggle Button -->
                        <button id="readingQuickCommentaryButton" aria-label="Switch to Commentary View">ðŸ“</button> <!-- Initial icon can be placeholder -->

                        <button id="audioModalTriggerButton" aria-label="Open Audio Player">
                            <span class="icon">ðŸŽ§</span>
                            <span class="visually-hidden">Audio Player</span>
                        </button>
                        <button id="readingQuickThemeButton" aria-label="Toggle theme"><span class="icon" id="readingQuickThemeIcon" aria-hidden="true">ðŸŒ™</span> <span class="visually-hidden">Toggle Theme</span></button>
                    </div>
                </div>

                <div class="chapter-nav-container">
                     <div class="reading-progress-bar-container" aria-hidden="true"><div class="reading-progress-bar" id="readingProgressBar"></div></div>
                    <nav class="chapter-nav" id="chapterNav" aria-label="Chapters"><!-- JS populates --></nav>
                </div>

                <!-- START: Chapter Introduction Header -->
                <div id="chapterIntroductionContainer" class="chapter-intro-header demo-style-2" style="display: none;"> <!-- Initially hidden, JS will show if content exists. Add your chosen classes here. -->
                    <p id="chapterIntroText"><!-- JS populates this --></p>
                </div>
                <!-- END: Chapter Introduction Header -->

                <div class="reading-content" id="readingContent" tabindex="-1" aria-live="polite"><!-- JS populates --></div>
                 <div class="reading-footer">
                     <nav aria-label="Chapter navigation">
                        <button class="nav-btn" id="prevChapter" disabled>Previous Chapter</button>
                        <button class="nav-btn" id="nextChapter" disabled>Next Chapter</button>
                    </nav>
                </div>
            </div>
        </div> <!-- /#readingView -->

        <!-- Bottom Navigation (Mobile Only) -->
         <nav class="bottom-nav" id="bottomNavTabs" role="navigation" aria-label="Main navigation">
             <div role="tablist">
                 <button role="tab" aria-controls="themeView" aria-selected="true" data-view="themeView"><span class="icon" aria-hidden="true">ðŸ›ï¸„1¤7</span>Themes</button>
                 <button role="tab" aria-controls="bookListView" aria-selected="false" data-view="bookListView"><span class="icon" aria-hidden="true">ðŸ“–</span>Books</button>
                 <!-- READING TAB BUTTON REMOVED -->
                 <button role="tab" aria-controls="notesView" aria-selected="false" data-view="notesView"><span class="icon" aria-hidden="true">ðŸ“</span>Notes</button>
                 <button role="tab" aria-controls="settingsView" aria-selected="false" data-view="settingsView"><span class="icon" aria-hidden="true">âš™ï¸</span>Settings</button>
             </div>
        </nav>

        <!-- START: Fullscreen Verse Overlay -->
        <div class="fullscreen-verse" id="fullscreenVerse" aria-modal="true" aria-hidden="true" role="dialog" aria-label="Verse of the Day Fullscreen View">
            <div class="fullscreen-content">
                <!-- Updated close button to match VOD styling and be a <button> with ID -->
                <button class="close-btn" id="fullscreenCloseBtn" aria-label="Close fullscreen view">Ã—</button>
                <!-- Added IDs to the content elements for JS reference -->
                <div class="verse-title" id="fullscreenVerseTitle"></div>
                <div class="verse-text" id="fullscreenVerseText"></div>
                <div class="verse-reference" id="fullscreenVerseReference"></div>
            </div>
        </div>
        <!-- END: Fullscreen Verse Overlay -->

     <!-- START: Verse Action Bar Container -->
     <div class="action-bar-container hidden" id="actionBarContainer" aria-hidden="true">
         <div class="action-buttons-container">
              <!-- ADDED: Done button to exit selection mode -->
              <button id="actionBarDoneBtn" class="button-secondary">Done</button>
             <!-- Each button now contains an icon and text label -->
             <button id="copyVerseBtn">
                 <i class="fas fa-copy"></i>
                 <span>Copy</span>
             </button>
             <button id="saveVerseBtn">
                 <i class="fas fa-bookmark"></i>
                 <span>Save</span>
             </button>
             <button id="noteVerseBtn">
                 <i class="fas fa-pencil-alt"></i>
                 <span>Note</span>
             </button>
             <button id="shareVerseBtn">
                 <i class="fas fa-share-alt"></i>
                 <span>Share</span>
             </button>
             <button id="imageVerseBtn">
                 <i class="fas fa-image"></i>
                 <span>Image</span>
             </button>
              <!-- ADDED: Commentary button to action bar -->
              <button id="commentaryVerseBtn">
                  <i class="fas fa-comments"></i> <!-- Using comment icon -->
                  <span>Commentary</span>
              </button>
             <!-- Add other buttons here as needed -->
         </div>
     </div>
     <!-- END: Verse Action Bar Container -->

    </div> <!-- /.app-container -->


    <!-- Download Manager Modal -->
    <div id="downloadModal" class="modal-overlay hidden" aria-hidden="true">
        <div class="modal-content download-modal-content">
            <div class="modal-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 class="modal-title" style="margin:0;">Offline Resources</h3>
                <button id="closeDownloadModalBtn" class="close-button" aria-label="Close" style="font-size:1.5rem; background:none; border:none; cursor:pointer;">×</button>
            </div>
            <div class="modal-body">
                <p class="modal-description">Select the resources you want to make available offline.</p>
                
                <div class="download-options-container">
                    <!-- Amharic Group -->
                    <fieldset class="download-language-group">
                        <legend>Amharic (አማርኛ)</legend>
                        <label class="download-option-item" data-package-id="am-bible">
                            <input type="checkbox">
                            <div class="option-details">
                                <span class="option-title">Bible Text</span>
                                <span class="option-status" data-status="not_downloaded">Not downloaded</span>
                            </div>
                        </label>
                        <label class="download-option-item" data-package-id="am-commentary">
                            <input type="checkbox">
                            <div class="option-details">
                                <span class="option-title">Commentary</span>
                                <span class="option-status" data-status="not_downloaded">Not downloaded</span>
                            </div>
                        </label>
                        <label class="download-option-item" data-package-id="am-ref">
                            <input type="checkbox">
                            <div class="option-details">
                                <span class="option-title">Cross-References</span>
                                <span class="option-status" data-status="not_downloaded">Not downloaded</span>
                            </div>
                        </label>
                    </fieldset>

                    <!-- English Group -->
                    <fieldset class="download-language-group">
                        <legend>English</legend>
                        <label class="download-option-item" data-package-id="en-bible">
                            <input type="checkbox">
                            <div class="option-details">
                                <span class="option-title">Bible Text</span>
                                <span class="option-status" data-status="not_downloaded">Not downloaded</span>
                            </div>
                        </label>
                        <label class="download-option-item" data-package-id="en-commentary">
                            <input type="checkbox">
                            <div class="option-details">
                                <span class="option-title">Commentary</span>
                                <span class="option-status" data-status="not_downloaded">Not downloaded</span>
                            </div>
                        </label>
                        <label class="download-option-item" data-package-id="en-ref">
                            <input type="checkbox">
                            <div class="option-details">
                                <span class="option-title">Cross-References</span>
                                <span class="option-status" data-status="not_downloaded">Not downloaded</span>
                            </div>
                        </label>
                    </fieldset>
                </div>

                <div id="downloadModalProgressContainer" class="download-progress-container" style="display:none;">
                    <p id="downloadModalProgressMessage">Initializing...</p>
                    <progress id="downloadModalProgressBar" value="0" max="100"></progress>
                </div>

                <div class="modal-actions" style="margin-top: 20px; text-align: right; display:flex; justify-content:flex-end; gap:10px;">
                    <button id="deleteSelectedDownloadsBtn" class="button-danger" style="display:none;">Delete Selected</button>
                    <button id="startSelectedDownloadsBtn" class="button-primary">Update Downloads</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Download Manager Modal -->
    <div id="downloadModal" class="modal-overlay hidden" aria-hidden="true">
        <div class="modal-content download-modal-content">
            <div class="modal-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 class="modal-title" style="margin:0;">Offline Resources</h3>
                <button id="closeDownloadModalBtn" class="close-button" aria-label="Close" style="font-size:1.5rem; background:none; border:none; cursor:pointer;">×</button>
            </div>
            <div class="modal-body">
                <p class="modal-description">Select the resources you want to make available offline.</p>
                
                <div class="download-options-container">
                    <!-- Amharic Group -->
                    <fieldset class="download-language-group">
                        <legend>Amharic (አማርኛ)</legend>
                        <label class="download-option-item" data-package-id="am-bible">
                            <input type="checkbox">
                            <div class="option-details">
                                <span class="option-title">Bible Text</span>
                                <span class="option-status" data-status="not_downloaded">Not downloaded</span>
                            </div>
                        </label>
                        <label class="download-option-item" data-package-id="am-commentary">
                            <input type="checkbox">
                            <div class="option-details">
                                <span class="option-title">Commentary</span>
                                <span class="option-status" data-status="not_downloaded">Not downloaded</span>
                            </div>
                        </label>
                        <label class="download-option-item" data-package-id="am-ref">
                            <input type="checkbox">
                            <div class="option-details">
                                <span class="option-title">Cross-References</span>
                                <span class="option-status" data-status="not_downloaded">Not downloaded</span>
                            </div>
                        </label>
                    </fieldset>

                    <!-- English Group -->
                    <fieldset class="download-language-group">
                        <legend>English</legend>
                        <label class="download-option-item" data-package-id="en-bible">
                            <input type="checkbox">
                            <div class="option-details">
                                <span class="option-title">Bible Text</span>
                                <span class="option-status" data-status="not_downloaded">Not downloaded</span>
                            </div>
                        </label>
                        <label class="download-option-item" data-package-id="en-commentary">
                            <input type="checkbox">
                            <div class="option-details">
                                <span class="option-title">Commentary</span>
                                <span class="option-status" data-status="not_downloaded">Not downloaded</span>
                            </div>
                        </label>
                        <label class="download-option-item" data-package-id="en-ref">
                            <input type="checkbox">
                            <div class="option-details">
                                <span class="option-title">Cross-References</span>
                                <span class="option-status" data-status="not_downloaded">Not downloaded</span>
                            </div>
                        </label>
                    </fieldset>
                </div>

                <div id="downloadModalProgressContainer" class="download-progress-container" style="display:none;">
                    <p id="downloadModalProgressMessage">Initializing...</p>
                    <progress id="downloadModalProgressBar" value="0" max="100"></progress>
                </div>

                <div class="modal-actions" style="margin-top: 20px; text-align: right; display:flex; justify-content:flex-end; gap:10px;">
                    <button id="deleteSelectedDownloadsBtn" class="button-danger" style="display:none;">Delete Selected</button>
                    <button id="startSelectedDownloadsBtn" class="button-primary">Update Downloads</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase SDK -->
    <!-- Using a recent stable version -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.47.1/dist/umd/supabase.min.js"></script>

    <!-- Audio Player Modal -->
    <div id="audioPlayerModal" class="modal-overlay hidden" aria-hidden="true">
        <div class="modal-content">
            <!-- Audio Player Header for chapter reference -->
            <div id="audioModalHeaderRef" class="audio-player-header"></div>
            <!-- Audio Player Structure -->
            <div class="audio-player">
              <audio id="audio" src=""></audio>

              <div class="progress-container">
                <input type="range" id="progressBar" value="0" min="0" max="100" step="0.1">
                <div class="time">
                  <span id="currentTime">0:00</span>
                  <span id="duration">0:00</span>
                </div>
              </div>

              <div class="controls">
                <button id="backwardBtn" aria-label="Skip backward 10 seconds">â„1¤7 10s</button>
                <button id="playPauseBtn" aria-label="Play/Pause Audio">â–¶ï¸</button>
                <button id="forwardBtn" aria-label="Skip forward 10 seconds">10s â„1¤7</button>
              </div>
               <!-- Optional Close button -->
               <button class="close-button" aria-label="Close Audio Player">Ã—</button>
            </div>
            <!-- End Audio Player Structure -->
        </div>
    </div>
    <!-- End Audio Player Modal -->
<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js')
                .then(reg => console.log('SW registered'))
                .catch(err => console.log('SW registration failed'));
        });
    }
</script>
    <!-- Your app's script -->
    <!-- Script tag for your combined JavaScript file -->
    <script type="module" src="app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
<script>
eruda.init();
</script>
</body>
</html>






